<attachment contenteditable="false" data-atts="%5B%5D" data-aid=".atts-951a8093-f05b-4801-9d1e-fa749a47bd4f"></attachment><p>版本：logstash 6.6.2</p><p>方法：用logstash过滤器中的json插件配置选项实现</p><p>首先介绍用到的参数</p><p><strong>参数：add_field</strong></p><p><strong>作用：添加字段</strong></p><p><strong>参数：%{field}</strong></p><p><strong>作用：调用事件中的指定字段</strong></p><p><strong>参数：remove_field</strong></p><p><strong>作用：删除字段</strong></p><p>官方插件资料：<a href="https://www.elastic.co/guide/en/logstash/6.6/plugins-filters-json.html" target="_blank" style="color: rgb(0, 155, 194);">https://www.elastic.co/guide/en/logstash/6.6/plugins-filters-json.html</a></p><p>通过文档描述，json插件可以将事件中的json格式日志提取到事件的根中，根中的字段传递到elasticsearch后，可以做过滤条件，而且展示起来比较直观。</p><p><strong>比如json日志格式为：</strong></p><p class="ql-align-right"><br></p><p><code style="background-color: initial;">{</code></p><p><code style="background-color: initial;">&nbsp;&nbsp;&nbsp;&nbsp;"name":"root",</code></p><p><code style="background-color: initial;">&nbsp;&nbsp;&nbsp;&nbsp;"info":{</code></p><p><code style="background-color: initial;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"from":"host1",</code></p><p><code style="background-color: initial;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"path":"var/log/log.log"</code></p><p><code style="background-color: initial;">&nbsp;&nbsp;&nbsp;&nbsp;}</code></p><p><code style="background-color: initial;">}</code></p><p><strong>info字段的值还是一个json，现在需要将info中的数据提取到事件的根中，也就是变为如下格式。</strong></p><p class="ql-align-right"><br></p><p><code style="background-color: initial;">{</code></p><p><code style="background-color: initial;">&nbsp;&nbsp;&nbsp;&nbsp;"name":"root",</code></p><p><code style="background-color: initial;">&nbsp;&nbsp;&nbsp;&nbsp;"from":"host1",</code></p><p><code style="background-color: initial;">&nbsp;&nbsp;&nbsp;&nbsp;"path":"var/log/log.log"</code></p><p><code style="background-color: initial;">}</code></p><p><strong># logstash配置文件</strong></p><p><code style="background-color: initial;">[root@localhost logstash]# cat kafka.conf </code></p><p><code style="background-color: initial;">input {</code></p><p>&nbsp;</p><p><code style="background-color: initial;">&nbsp;&nbsp;&nbsp;&nbsp;kafka {</code></p><p><code style="background-color: initial;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;bootstrap_servers =&gt; ["192.168.10.74:9092"]</code></p><p><code style="background-color: initial;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;client_id =&gt; "test1"</code></p><p><code style="background-color: initial;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;group_id =&gt; "test1"</code></p><p><code style="background-color: initial;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auto_offset_reset =&gt; "latest"</code></p><p><code style="background-color: initial;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;consumer_threads =&gt; 1</code></p><p><code style="background-color: initial;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;decorate_events =&gt; false</code></p><p><code style="background-color: initial;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;topics =&gt; ["test"]</code></p><p><code style="background-color: initial;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;type =&gt; "fromk"</code></p><p><code style="background-color: initial;">&nbsp;&nbsp;&nbsp;&nbsp;}</code></p><p><code style="background-color: initial;">&nbsp;</code>&nbsp;</p><p><code style="background-color: initial;">}</code></p><p>&nbsp;</p><p><code style="background-color: initial;"># 将message字段的数据(json格式) "导入"</code></p><p><code style="background-color: initial;">filter {</code></p><p><code style="background-color: initial;">&nbsp;&nbsp;&nbsp;&nbsp;json {</code></p><p><code style="background-color: initial;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# 输入的日志，都会进入message字段，使用source解析json。</code></p><p><code style="background-color: initial;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;source =&gt; "message"</code></p><p><code style="background-color: initial;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# 添加列，便于下面再执行source</code></p><p><code style="background-color: initial;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;add_field =&gt; { "javalog" =&gt; "%{info}" }</code></p><p><code style="background-color: initial;">&nbsp;&nbsp;&nbsp;&nbsp;}</code></p><p>&nbsp;</p><p><code style="background-color: initial;">&nbsp;&nbsp;&nbsp;&nbsp;# 第二次解析json串</code></p><p><code style="background-color: initial;">&nbsp;&nbsp;&nbsp;&nbsp;json {</code></p><p><code style="background-color: initial;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;source =&gt; "javalog"</code></p><p><code style="background-color: initial;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# 移除列，info字段和javalog字段不需转存到elasticsearch。</code></p><p><code style="background-color: initial;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;remove_field =&gt; [ "info","javalog" ]</code></p><p><code style="background-color: initial;">&nbsp;&nbsp;&nbsp;&nbsp;}</code></p><p><code style="background-color: initial;">}</code></p><p>&nbsp;</p><p>&nbsp;</p><p><code style="background-color: initial;">output {</code></p><p>&nbsp;</p><p><code style="background-color: initial;">&nbsp;&nbsp;&nbsp;&nbsp;elasticsearch {</code></p><p><code style="background-color: initial;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;hosts =&gt; "192.168.10.74"</code></p><p><code style="background-color: initial;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;index =&gt; "jar-log-%{+YYYY.MM.dd}"</code></p><p><code style="background-color: initial;">&nbsp;&nbsp;&nbsp;&nbsp;}</code></p><p>&nbsp;</p><p><code style="background-color: initial;">&nbsp;&nbsp;&nbsp;&nbsp;stdout {</code></p><p><code style="background-color: initial;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;codec =&gt; rubydebug</code></p><p><code style="background-color: initial;">&nbsp;&nbsp;&nbsp;&nbsp;}</code></p><p><code style="background-color: initial;">}</code></p><p>效果：<a href="http://www.rootop.org/wp-content/uploads/2019/08/20190826120035.png" target="_blank" style="color: rgb(0, 155, 194);"><img src="http://www.rootop.org/wp-content/uploads/2019/08/20190826120035.png" height="221" width="1283"></a></p><p>kibana中展示效果<a href="http://www.rootop.org/wp-content/uploads/2019/08/20190826120147.png" target="_blank" style="color: rgb(119, 119, 119);"><img src="http://www.rootop.org/wp-content/uploads/2019/08/20190826120147.png" height="225" width="1918"></a></p><p><br></p>