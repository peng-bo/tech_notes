<attachment contenteditable="false" data-atts="%5B%5D" data-aid=".atts-dcdfbccd-0b9d-4b10-bdc5-fda2ac2672fe"></attachment><p>2. ZooKeeper安装与配置</p><p>ZooKeeper 是安装 Kafka 集群的必要组件，Kafka 通过 ZooKeeper 来实施对元数据信息的管理，包括集群、broker、主题、分区等内容。</p><p><br></p><p>ZooKeeper 是一个开源的分布式协调服务，是 Google Chubby的一个开源实现。分布式应用程序可以基于 ZooKeeper 实现诸如数据发布/订阅、负载均衡、命名服务、分布式协调/通知、集群管理、Master 选举、配置维护等功能。</p><p><br></p><p>在 ZooKeeper 中共有3个角色：leader、follower 和 observer，同一时刻 ZooKeeper 集群中只会有一个 leader，其他的都是 follower 和 observer。observer 不参与投票，默认情况下 ZooKeeper 中只有 leader 和 follower 两个角色。更多相关知识可以查阅 ZooKeeper 官方网站来获得。</p><p><br></p><p>安装 ZooKeeper 的第一步也是下载相应的安装包，安装包可以从官网中获得，示例中使用的安装包是 zookeeper-3.4.12.tar.gz，同样将其复制到/opt 目录下，然后解压缩，参考如下：</p><p><br></p><p>[root@node1 opt]# ll zookeeper-3.4.12.tar.gz&nbsp;</p><p>-rw-r--r-- 1 root root 36667596 Aug 31 15:55 zookeeper-3.4.12.tar.gz</p><p>[root@node1 opt]# tar zxvf zookeeper-3.4.12.tar.gz&nbsp;</p><p># 解压之后当前/opt目录下生成一个名为zookeeper-3.4.12的文件夹</p><p>[root@node1 opt]# cd zookeeper-3.4.12</p><p>[root@node1 zookeeper-3.4.12]# pwd</p><p>/opt/zookeeper-3.4.12</p><p>第二步，向/etc/profile 配置文件中添加如下内容，并执行 source /etc/profile 命令使配置生效：</p><p><br></p><p>export ZOOKEEPER_HOME=/opt/zookeeper-3.4.12</p><p>export PATH=$PATH:$ZOOKEEPER_HOME/bin</p><p>第三步，修改 ZooKeeper 的配置文件。首先进入$ZOOKEEPER_HOME/conf目录，并将zoo_sample.cfg 文件修改为 zoo.cfg：</p><p><br></p><p>[root@node1 zookeeper-3.4.12]# cd conf</p><p>[root@node1 conf]# cp zoo_sample.cfg zoo.cfg</p><p>然后修改 zoo.cfg 配置文件，zoo.cfg 文件的内容参考如下：</p><p><br></p><p># ZooKeeper服务器心跳时间，单位为ms</p><p>tickTime=2000</p><p># 允许follower连接并同步到leader的初始化连接时间，以tickTime的倍数来表示</p><p>initLimit=10</p><p># leader与follower心跳检测最大容忍时间，响应超过syncLimit*tickTime，leader认为</p><p># follower“死掉”，从服务器列表中删除follower</p><p>syncLimit=5</p><p># 数据目录</p><p>dataDir=/tmp/zookeeper/data</p><p># 日志目录</p><p>dataLogDir=/tmp/zookeeper/log</p><p># ZooKeeper对外服务端口</p><p>clientPort=2181</p><p>默认情况下，Linux 系统中没有/tmp/zookeeper/data 和/tmp/zookeeper/log 这两个目录，所以接下来还要创建这两个目录：</p><p><br></p><p>[root@node1 conf]# mkdir -p /tmp/zookeeper/data</p><p>[root@node1 conf]# mkdir -p /tmp/zookeeper/log</p><p>第四步，在${dataDir}目录（也就是/tmp/zookeeper/data）下创建一个 myid 文件，并写入一个数值，比如0。myid 文件里存放的是服务器的编号。</p><p><br></p><p>第五步，启动 Zookeeper 服务，详情如下：</p><p><br></p><p>[root@node1 conf]# zkServer.sh start</p><p>JMX enabled by default</p><p>Using config: /opt/zookeeper-3.4.6/bin/../conf/zoo.cfg</p><p>Starting zookeeper ... STARTED</p><p>可以通过 zkServer.sh status 命令查看 Zookeeper 服务状态，示例如下：</p><p><br></p><p>[root@node1 ]# zkServer.sh status</p><p>JMX enabled by default</p><p>Using config: /opt/zookeeper-3.4.12/bin/../conf/zoo.cfg</p><p>Mode: Standalone</p><p>以上是关于 ZooKeeper 单机模式的安装与配置，一般在生产环境中使用的都是集群模式，集群模式的配置也比较简单，相比单机模式而言只需要修改一些配置即可。下面以3台机器为例来配置一个 ZooKeeper 集群。首先在这3台机器的 /etc/hosts 文件中添加3台集群的IP地址与机器域名的映射，示例如下（3个IP地址分别对应3台机器）：</p><p><br></p><p>192.168.0.2 node1</p><p>192.168.0.3 node2</p><p>192.168.0.4 node3</p><p>然后在这3台机器的 zoo.cfg 文件中添加以下配置：</p><p><br></p><p>server.0=node1:2888:3888</p><p>server.1=node2:2888:3888</p><p>server.2=node3:2888:3888</p><p>为了便于讲解上面的配置，这里抽象出一个公式，即 server.A=B:C:D。其中A是一个数字，代表服务器的编号，就是前面所说的 myid 文件里面的值。集群中每台服务器的编号都必须唯一，所以要保证每台服务器中的 myid 文件中的值不同。B代表服务器的IP地址。C表示服务器与集群中的 leader 服务器交换信息的端口。D表示选举时服务器相互通信的端口。如此，集群模式的配置就告一段落，可以在这3台机器上各自执行 zkServer.sh start 命令来启动服务。</p><p><br></p><p>3. Kafka的安装与配置</p><p>在安装完 JDK 和 ZooKeeper 之后，就可以执行 Kafka broker 的安装了，首先也是从官网中下载安装包，示例中选用的安装包是 kafka_2.11-2.0.0.tgz，将其复制至/opt 目录下并进行解压缩，示例如下：</p><p><br></p><p>[root@node1 opt]# ll kafka_2.11-2.0.0.tgz&nbsp;</p><p>-rw-r--r-- 1 root root 55751827 Jul 31 10:45 kafka_2.11-2.0.0.tgz</p><p>[root@node1 opt]# tar zxvf kafka_2.11-2.0.0.tgz</p><p># 解压之后当前/opt目录下生成一个名为kafka_2.11-2.0.0的文件夹</p><p>[root@node1 opt]# cd kafka_2.11-2.0.0</p><p>[root@node1 kafka_2.11-2.0.0]#</p><p># Kafka的根目录$KAFKA_HOME即为/opt/kafka_2.11-2.0.0，可以将Kafka_HOME添加到/etc/profile文件中，具体做法可以参考前面JDK和ZooKeeper的安装示例</p><p>接下来需要修改 broker 的配置文件 $KAFKA_HOME/conf/server.properties。主要关注以下几个配置参数即可：</p><p><br></p><p># broker的编号，如果集群中有多个broker，则每个broker的编号需要设置的不同</p><p>broker.id=0</p><p># broker对外提供的服务入口地址</p><p>listeners=PLAINTEXT://localhost:9092</p><p># 存放消息日志文件的地址</p><p>log.dirs=/tmp/kafka-logs</p><p># Kafka所需的ZooKeeper集群地址，为了方便演示，我们假设Kafka和ZooKeeper都安装在本机</p><p>zookeeper.connect=localhost:2181/kafka</p><p>如果是单机模式，那么修改完上述配置参数之后就可以启动服务。如果是集群模式，那么只需要对单机模式的配置文件做相应的修改即可：确保集群中每个 broker 的 broker.id 配置参数的值不一样，以及 listeners 配置参数也需要修改为与 broker 对应的IP地址或域名，之后就可以各自启动服务。注意，在启动 Kafka 服务之前同样需要确保 zookeeper.connect 参数所配置的 ZooKeeper 服务已经正确启动。</p><p><br></p><p>启动 Kafka 服务的方式比较简单，在$KAFKA_HOME 目录下执行下面的命令即可：</p><p><br></p><p>bin/kafka-server-start.sh config/server.properties</p><p>如果要在后台运行 Kafka 服务，那么可以在启动命令中加入 -daemon 参数或&amp;字符，示例如下：</p><p><br></p><p>bin/kafka-server-start.sh –daemon config/server.properties</p><p># 或者</p><p>bin/kafka-server-start.sh config/server.properties &amp;</p><p>可以通过 jps 命令查看 Kafka 服务进程是否已经启动，示例如下：</p><p><br></p><p>[root@node1 kafka_2.11-2.0.0]# jps -l</p><p>23152 sun.tools.jps.Jps</p><p>16052 org.apache.zookeeper.server.quorum.QuorumPeerMain</p><p>22807 kafka.Kafka&nbsp;# 这个就是Kafka服务端的进程</p><p><br></p>