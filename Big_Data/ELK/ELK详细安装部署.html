<attachment contenteditable="false" data-atts="%5B%5D" data-aid=".atts-1645db5c-cb07-4add-8332-768da20115f9"></attachment><p>elastic官网地址：https://www.elastic.co/cn/</p><p>elastic产品地址：https://www.elastic.co/cn/elastic-stack</p><p>yum源地址：https://mirrors.tuna.tsinghua.edu.cn/elasticstack/yum</p><p><br></p><p><strong style="color: rgb(77, 77, 77);">版本说明：</strong></p><p><span style="color: rgb(77, 77, 77);">Elasticsearch、Logstash、Kibana、Filebeat安装的版本号必须全部一致,不然会出现kibana无法显示web页面。</span></p><p><br></p><p>ELK常见的几种架构：</p><p>1 Elasticsearch + Logstash + Kibana</p><p>这是一种最简单的架构。这种架构，通过logstash收集日志，Elasticsearch分析日志，然后在Kibana(web界面)中展示。这种架构虽然是官网介绍里的方式，但是往往在生产中很少使用。</p><p><br></p><p>2 Elasticsearch + Logstash + filebeat + Kibana</p><p>与上一种架构相比，这种架构增加了一个filebeat模块。filebeat是一个轻量的日志收集代理，用来部署在客户端，优势是消耗非常少的资源(较logstash)， 所以生产中，往往会采取这种架构方式，但是这种架构有一个缺点，当logstash出现故障， 会造成日志的丢失。</p><p><br></p><p>3 Elasticsearch + Logstash + filebeat + redis(也可以是其他中间件，比如RabbitMQ) + Kibana</p><p>这种架构是上面那个架构的完善版，通过增加中间件，来避免数据的丢失。当Logstash出现故障，日志还是存在中间件中，当Logstash再次启动，则会读取中间件中积压的日志。</p><p><br></p><h2>yum安装</h2><p>ELK安装需要以非root用户安装。</p><p><br></p><p>yum安装</p><p>ELK安装需要以非root用户安装。</p><p><br></p><p>1.配置JDK环境</p><p>自行下载jdk-11.0.7_linux-x64_bin.rpm</p><p><br></p><p>1.安装jdk</p><p>&gt;rpm -ivh jdk-11.0.7_linux-x64_bin.rpm</p><p>2.配置环境变量</p><p>&gt;vim /etc/profile.d/java.sh</p><p>&nbsp;export JAVA_HOME=/usr/java/jdk-11.0.7</p><p>&nbsp;export PATH=$JAVA_HOME/bin:$PATH</p><p>3.执行脚本</p><p>&gt;source /etc/profile.d/java.sh</p><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p><p>2.配置ELK yum源</p><p><br></p><p>&gt;vim /etc/yum.repo.d/ELK.repo</p><p>&nbsp;[ELK]</p><p>&nbsp;name=ELK-Elasticstack</p><p>&nbsp;baseurl=https://mirrors.tuna.tsinghua.edu.cn/elasticstack/yum/elastic-7.x/</p><p>&nbsp;gpgcheck=0</p><p>&nbsp;enabled=1</p><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>3.部署elasticsearch</p><p><br></p><p>3.1.安装elasticsearch</p><p><br></p><p>&gt;yum install -y elasticsearch-7.7.1</p><p>1</p><p>3.2.修改配置文件</p><p><br></p><p>vi /etc/elasticsearch/elasticsearch.yml</p><p><br></p><p>cluster.name: my-es</p><p>node.name: node-1</p><p>path.data: /data/elk/es/data</p><p>path.logs: /data/elk/es/logs</p><p>network.host: 127.0.0.1</p><p>http.port: 9200</p><p><br></p><p>3.3.创建目录</p><p><br></p><p>#创建数据库及日志目录</p><p>&gt;mkdir -p /data/elk/es/data</p><p>&gt;mkdir -p /data/elk/es/logs</p><p>#修改目录权限</p><p>&gt;chown -R elasticsearch:elasticsearch /data/elk/es</p><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>3.4.限制资源使用</p><p><br></p><p>&gt;vim /etc/security/limits.conf</p><p>&nbsp;elasticsearch soft memlock unlimited</p><p>&nbsp;elasticsearch hard memlock unlimited</p><p>&nbsp;elasticsearch soft nofile 65536</p><p>&nbsp;elasticsearch hard nofile 65536</p><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>3.5.添加防火墙</p><p><br></p><p>#对于elasticsearch端口，需要限制IP访问</p><p>&gt;firewall-cmd --permanent --add-rich-rule="rule family="ipv4" source address="指定IP" port protocol="tcp" port="9200" accept"</p><p>&gt;firewall-cmd --permanent --add-rich-rule="rule family="ipv4" source address="指定IP" port protocol="tcp" port="9300" accept"</p><p>&gt;firewall-cmd --reload</p><p>1</p><p>2</p><p>3</p><p>4</p><p>3.6.启动elasticsearch</p><p><br></p><p>#启动</p><p>&gt;systemctl restart elasticsearch.service</p><p>#查看端口监听</p><p>&gt;netstat -anpt</p><p>#查看是否已运行,若出现如下数据，则安装成功</p><p>&gt;curl http://localhost:9200</p><p>&nbsp;{</p><p>&nbsp;&nbsp;"name" : "node-1",</p><p>&nbsp;&nbsp;"cluster_name" : "my-es",</p><p>&nbsp;&nbsp;"cluster_uuid" : "Q7svyfAVQPmLtXsfHXoFDw",</p><p>&nbsp;&nbsp;"version" : {</p><p>&nbsp;&nbsp;"number" : "7.7.1",</p><p>&nbsp;&nbsp;"build_flavor" : "default",</p><p>&nbsp;&nbsp;"build_type" : "rpm",</p><p>&nbsp;&nbsp;"build_hash" : "ad56dce891c901a492bb1ee393f12dfff473a423",</p><p>&nbsp;&nbsp;"build_date" : "2020-05-28T16:30:01.040088Z",</p><p>&nbsp;&nbsp;"build_snapshot" : false,</p><p>&nbsp;&nbsp;"lucene_version" : "8.5.1",</p><p>&nbsp;&nbsp;"minimum_wire_compatibility_version" : "6.8.0",</p><p>&nbsp;&nbsp;"minimum_index_compatibility_version" : "6.0.0-beta1"</p><p>&nbsp;},</p><p>&nbsp;"tagline" : "You Know, for Search"</p><p>}</p><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p><p>9</p><p>10</p><p>11</p><p>12</p><p>13</p><p>14</p><p>15</p><p>16</p><p>17</p><p>18</p><p>19</p><p>20</p><p>21</p><p>22</p><p>23</p><p>3.7.elasticsearch部分配置说明</p><p><br></p><p>属性名	说明</p><p>cluster.name	配置elasticsearch的集群名称。</p><p>node.name	节点名，es会默认随机指定一个名字，用户可自行配置。</p><p>path.data	设置索引数据的存储路径，默认是es根目录下的data文件夹，可以设置多个存储路径，用逗号分隔。</p><p>path.logs	设置日志文件的存储路径，默认是es根目录下的logs文件夹。</p><p>path.conf	设置配置文件的存储路径，tar或zip包安装默认在es根目录下的config文件夹，rpm安装默认在/etc/ elasticsearch。</p><p>path.plugins	设置插件的存放路径，默认是es根目录下的plugins文件夹。</p><p>bootstrap.memory_lock	设置为true可以锁住ES使用的内存，避免内存进行swap。</p><p>network.host	设置bind_host和publish_host，设置为0.0.0.0允许所有外网访问。</p><p>http.port	设置对外服务的http端口，默认为9200。</p><p>transport.tcp.port	集群结点之间通信端口，默认为9300。</p><p>discovery.zen.ping.timeout	设置ES自动发现节点连接超时的时间，默认为3S。</p><p>discovery.zen.minimum_master_nodes	主结点数量的最少值 ,此值的公式为：(master_eligible_nodes / 2) + 1 ，比如：有3个符合要求的主结点，那么这里要设置为2。</p><p>discovery.seed_hosts	集群发现，配置该节点会与哪些候选地址进行通信，hostname,ip,ip+port，比如：[“127.0.0.1:9300”]。</p><p>cluster.initial_master_nodes	当你第一次启动全新的Elasticsearch集群时，会有一个集群引导(cluster bootstrapping)步骤，这个步骤会确定一个在第一次选举中投票被计数的、并且可以成为master节点的集合。在开发模式，如果没有配置 discovery settings，该步骤由节点自身自动执行。因为这种自动引导本质上是不安全的，当您在生产模式下启动一个全新的集群时，你必须显式指定那些可以成为master节点的名称或者IP地址，这些节点应该在第一次选举中计算选票数。</p><p>4.部署kibana</p><p>Kibana是node.js 编写的，不需要java环境。直接安装即可。</p><p><br></p><p>4.1.安装kibana</p><p><br></p><p>&gt;yum install -y kibana-7.7.1</p><p>1</p><p>4.2.修改配置文件</p><p><br></p><p>vi /etc/kibana/kibana.yml</p><p><br></p><p>server.port: 5601</p><p>server.host: “0.0.0.0”</p><p>elasticsearch.hosts: [“http://localhost:9200”]</p><p>kibana.index: “.kibana”</p><p><br></p><p>4.3.添加防火墙</p><p><br></p><p>firewall-cmd --add-port=5601/tcp --permanent</p><p>firewall-cmd --reload</p><p>1</p><p>2</p><p>4.4.启动kibana</p><p><br></p><p>&gt;systemctl restart kibana.service</p><p>1</p><p>4.5.访问</p><p>浏览器上输入：http://ip:5601，出现以下界面，则安装成功。同时由于启动较慢，可多刷新几次。</p><p><br></p><p>5.部署logstash</p><p>由于直接使用yum install -y logstash-7.7.1，无法启动，所以这里使用rpm安装方式。</p><p><br></p><p>5.1.下载安装包</p><p><br></p><p>&gt;wget https://mirrors.tuna.tsinghua.edu.cn/elasticstack/yum/elastic-7.x/7.7.1/logstash-7.7.1.rpm</p><p>1</p><p>5.2.安装logstash</p><p><br></p><p>&gt;sudo rpm -ivh logstash-7.7.1.rpm</p><p>1</p><p>5.3.修改配置文件</p><p><br></p><p>vim /etc/logstash/logstash.yml</p><p><br></p><p>http.host: “0.0.0.0”</p><p>http.port: 9600-9700</p><p><br></p><p>5.4.增加配置</p><p><br></p><p>cp /etc/logstash/logstash-sample.conf /etc/logstash/conf.d/logstash.conf</p><p><br></p><p>根据实际需求来配置该文件。比如：</p><p>input {</p><p>beats {</p><p>port =&gt; 5044</p><p>}</p><p>}</p><p>output {</p><p>elasticsearch {</p><p>hosts =&gt; [“ES地址:9200”]</p><p>index =&gt; “logstash-%{+YYYY.MM.dd}”</p><p>}</p><p>}</p><p><br></p><p>5.5.添加防火墙</p><p><br></p><p>firewall-cmd --add-port=5044/tcp --permanent</p><p>firewall-cmd --add-port=9600/tcp --permanent</p><p>firewall-cmd --reload</p><p>1</p><p>2</p><p>3</p><p>5.6.启动logstash</p><p><br></p><p>&gt;systemctl restart logstash.service</p><p>1</p><p>5.7.查看是否启动成功</p><p><br></p><p>&gt;netstat -anpt</p><p>1</p><p>6.部署filebeat</p><p>在需要收集日志的服务器上安装filebeat。、</p><p><br></p><p>6.1.安装filebeat</p><p><br></p><p>&gt;wget https://artifacts.elastic.co/downloads/beats/filebeat/filebeat-7.7.1-x86_64.rpm</p><p>&gt;rpm -ivh filebeat-7.7.1-x86_64.rpm</p><p>1</p><p>2</p><p>6.2.修改配置文件</p><p><br></p><p>vi /etc/filebeat/filebeat.yml</p><p>#配置需要采集的日志</p><p><br></p><p>paths:</p><p>‘- /usr/local/应用/logs/*.log’</p><p><br></p><p>#配置采集日志输出位置</p><p><br></p><p>#输出到屏幕</p><p>#output.console:</p><p>#enable: true</p><p><br></p><p>#输出到logstash</p><p>output.logstash:</p><p>#The Logstash hosts</p><p>hosts: [“logstash服务器IP:5044”]</p><p><br></p><p>6.3.启动filebeat</p><p><br></p><p>&gt;systemctl restart filebeat.service</p><p>1</p><p>6.4.查看filebeat是否运行正常</p><p><br></p><p>&gt;journalctl -u filebeat.service</p><p><br></p><p><br></p><p><br></p>